<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <style>
    body {
      font: 12px sans-serif;
    }

    .axis path,
    .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
    }

    .line {
      fill: none;
      stroke: steelblue;
      stroke-width: 5px;
    }

    #chart {
      width: 100%;
      height: 94%;
      position: absolute;
    }

    .fixed-bottom .card-body {
      padding: .4rem !important;
    }

    .grid line {
      stroke: #bbccdd;
    }

    legend {
      padding: 1rem;
    }

    button.close {
      font-size: small;
      color: gray;
    }

    tr {
      vertical-align: baseline;
    }

    th.population,
    td.population {
      font-family: monospace;
      text-align: right;
    }
  </style>

  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
  <div class="container-fluid">
    <div class="fixed-top px-2">
      <div class="float-right">
        sources:
        <a href="https://pomber.github.io/covid19/timeseries.json" target="_json-data_source">data</a>
        |
        <a href="https://github.com/aequologica/aequologica.github.io/blob/master/covid/index.html" target="_json_data_source">html</a>
      </div>
      <h2 id="title"></h2>
      <p>
        <input type="range" min="1" max="10" value="4" class="slider" id="range">
        <span id="bubble"></span>
        <span id="subtitle"></span>
      </p>
    </div>

    <svg id="chart"></svg>

    <div class="fixed-bottom">
      <div class="float-right p-2">
        <div class="card" style="display: inline-block">
          <div class="card-body">
            <div class="custom-control custom-radio custom-control-inline">
              <input type="radio" id="absolute" name="absolute" class="custom-control-input" checked>
              <label class="custom-control-label" for="absolute">absolute</label>
            </div>
            <div class="custom-control custom-radio custom-control-inline">
              <input type="radio" id="percapita" name="absolute" class="custom-control-input">
              <label class="custom-control-label" for="percapita">per capita</label>
            </div>
          </div>
        </div>
        <div class="card" style="display: inline-block">
          <div class="card-body">
            <div class="custom-control custom-radio custom-control-inline">
              <input type="radio" id="linear" name="linear" class="custom-control-input" checked>
              <label class="custom-control-label" for="linear">linear</label>
            </div>
            <div class="custom-control custom-radio custom-control-inline">
              <input type="radio" id="logaritmic" name="linear" class="custom-control-input">
              <label class="custom-control-label" for="logaritmic">logaritmic</label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js" integrity="sha256-VeNaFBVDhoX3H+gJ37DpT/nTuZTdjYro9yBruHjVmoQ=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@5.15.1/dist/d3.min.js" integrity="sha256-SQJ/nCYPXFPuqoS56EfnesDBPNiitndOIfN2WdPRi/o=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.24.0/moment.min.js"></script>

  <!-- https://github.com/doowb/sma -->
  <!-- script src="https://cdn.jsdelivr.net/npm/sma@0.1.1/index.min.js"></script -->
  <script src="sma.js"></script>
  <script src="population.js"></script>

  <script>

    var ranges = document.querySelectorAll('[type="range"]');
    ranges.forEach(function (r) {
      r.addEventListener("input", () => {
        bubble.innerHTML = r.value;
      });
      r.addEventListener("change", () => {
        bubble.innerHTML = r.value;
        if (sizeOfAverage != r.value) {
          sizeOfAverage = r.value;
          raz();
          draw();
        }
      });
    });

    var radios = document.querySelectorAll('[type="radio"]');

    radios.forEach(function (r) {
      r.addEventListener("click", function (e) {
        var oldLinear = toggleLinear, oldCapita = toggleCapita;
        switch (this.id) {
          case "linear":
            toggleLinear = "linear";
            break;
          case "logaritmic":
            toggleLinear = "logaritmic";
            break;
          case "absolute":
            toggleCapita = "absolute";
            break;
          case "percapita":
            toggleCapita = "percapita";
            break;
          default:
            ;
        }
        if (oldLinear != toggleLinear || oldCapita != toggleCapita) {
          raz();
          draw();
        }
      });
    });

    var field = "deltaMovingAverage";
    var sizeOfAverage = 4;
    var startAfterNDeaths = 5;
    var populations = {};
    var countries = _.sortBy(["France", "Italy", "US", "Spain", "Belgium", "Luxembourg", "Germany"]);
    var aliases = { US: "United States" };
    function getPopulation(country) {
      var index = _.sortedIndexBy(populationByCountry, { 'name': aliases[country] ? aliases[country] : country }, 'name');
      return populationByCountry[index].count;
    }
    countries.forEach(function (country) {
      _.assign(populations, { [country]: getPopulation(country) });
    });

    var toggleCapita = "absolute"; // "percapita"
    var toggleLinear = "linear";   // "logaritmic"

    function raz() {
      var elem = document.querySelector('#chart');
      if (elem) {
        while (elem.firstChild) {
          elem.removeChild(elem.lastChild);
        }
      }
    }

    function draw() {
      // Define margins
      var margin = { top: 100, right: 80, bottom: 32, left: 50 },
        width =
          parseInt(d3.select("#chart").style("width")) - margin.left - margin.right,
        height =
          parseInt(d3.select("#chart").style("height")) - margin.top - margin.bottom;

      // Define date parser
      var parseDate = d3.timeParse("%Y-%m-%d");

      // Define scales
      var xScale = d3.scaleTime().range([0, width]);
      var yScale = (toggleLinear == "logaritmic" ? d3.scaleSymlog() : d3.scaleLinear()).range([height, 0]);
      var color = d3.scaleOrdinal().range(d3.schemeCategory10);

      // Define axes
      var xAxis = d3.axisBottom().scale(xScale);
      var yAxis = d3.axisRight().scale(yScale);

      // Define lines
      var line = d3
        .line()
        .curve(d3.curveMonotoneX)
        .x(function (d) {
          return xScale(d["date"]);
        })
        .y(function (d) {
          return yScale(d[field]);
        });

      // Define svg canvas
      var svg = d3
        .select("#chart")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      // Read in data
      d3.json("https://pomber.github.io/covid19/timeseries.json").then(function (dataParam) {

        var data = {};
        countries.forEach(function (country) {
          _.assign(data, { [country]: dataParam[country] });
        });

        // Set the color domain equal to the countries
        color.domain(countries);

        // calc start date as with respect to first # of deaths for all countries
        var start = moment("2020-02-01"); // default
        {
          var firstNDeaths = {};

          countries.forEach(function (country) {
            firstNDeaths[country] = _.find(data[country], function (d) { return d.deaths >= startAfterNDeaths; });
          });
          var firstNDeathsArray = _.values(firstNDeaths);

          firstNDeathsArray.sort(function compare(a, b) {
            return moment(parseDate(a.date)) - moment(parseDate(b.date));
          });

          var minFirstNDeaths = firstNDeathsArray[0];

          start = moment(parseDate(minFirstNDeaths.date)); // 
        }

        // Format the data 
        countries.forEach(function (country) {

          var prev = 0;

          data[country].forEach(function (d) {
            d.date = parseDate(d.date);
            d.deaths = +d.deaths;
            d.delta = (d.deaths - prev);
            if (toggleCapita == "percapita") {
              d.delta = d.delta / (populations[country] / 1000000)
            }
            prev = d.deaths;
          });

          var deltas = _.map(data[country], 'delta');
          var deltasMovingAverage = sma(deltas, sizeOfAverage);

          var i = 0;
          data[country].forEach(function (d) {
            d.deltaMovingAverage = i < sizeOfAverage ? 0 : deltasMovingAverage[i - sizeOfAverage];
            i = i + 1;
          });

          data[country] = _.filter(data[country], function (d) {
            return moment(d.date).isSameOrAfter(start);
          });
        });

        // Reformat data to make it more copasetic for d3
        // data = An array of objects
        // deathss = An array of three objects, each of which contains an array of objects
        var deathss = countries.map(function (country) {
          return {
            category: country,
            datapoints: data[country]
          };
        });

        // console.log(JSON.stringify(deathss, null, 2)) // to view the structure

        // Set the domain of the axes
        xScale.domain(
          d3.extent(deathss[0].datapoints, function (d) {
            return d.date;
          })
        );

        var yExtents = deathss.map(function (deaths) {
          return d3.extent(deaths.datapoints, function (d) {
            return d.delta;
          });
        });
        var yExtent = [
          d3.min(yExtents, function (d) { return d[0] }),
          d3.max(yExtents, function (d) { return d[1] })
        ];
        yScale.domain(yExtent);

        // Place the axes on the chart
        svg
          .append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis);

        svg
          .append("g")
          .attr("class", "y axis")
          .attr("transform", "translate(" + width + ", 0)")
          .call(yAxis);

        var products = svg
          .selectAll(".category")
          .data(deathss)
          .enter()
          .append("g")
          .attr("class", "category");

        products
          .append("path")
          .attr("class", "line")
          .attr("id", function (d, i) {
            return "line" + i;
          })
          .attr("d", function (d) {
            return line(d.datapoints);
          })
          .style("stroke", function (d) {
            return color(d.category);
          });

        // grid lines
        function make_y_gridlines() {
          return d3.axisRight(yScale)
            .ticks(10)
        }
        svg.append("g")
          .attr("class", "grid")
          .style("stroke-dasharray", ("3,3"))
          .call(make_y_gridlines()
            .tickSize(width)
            .tickFormat("")
          );

        // legend
        var fo = svg.append("foreignObject")
          .attr("x", 0)
          .attr("y", 0)
          .attr("width", 240)
          .attr("height", 240);
        var div = fo.append('xhtml:div');
        div.attr("class", "px-2");
        var t = div.append('table');
        var r = t.append('tr');
        var add = r.append('th').append('button');
        add.attr("type", "button");
        add.attr("class", "btn btn-light btn-sm");
        add.append('span').html("+");
        r.append('th').attr("class", "population").html("population");
        r.append('th').html("&nbsp;");
        countries.forEach(function (d, i) {
          var r = t.append('tr');
          r.append('th').attr("style", "color:" + color(d)).html(d);
          r.append('td').attr("class", "population").html(new Intl.NumberFormat().format(populations[d]));
          var del = r.append('td').append('button');
          del.attr("type", "button").attr("class", "close");
          del.append('span').html("&times;");
        });
        var buttons = document.querySelectorAll('[type="button"]');
        buttons.forEach(function (b) {
          b.addEventListener("click", function () {
            alert("work in progress");
          })
        });

        // titles, etc.
        document.getElementById("title").innerHTML = "Daily deaths"
        document.getElementById("bubble").innerHTML = sizeOfAverage;
        document.getElementById("subtitle").innerHTML = "days rolling average";

        // animate cf. http://bl.ocks.org/fryford/2925ecf70ac9d9b51031
        {
          var i = 0;
          d3.selectAll(".line").style("opacity", "0.5");

          //Select All of the lines and process them one by one
          d3.selectAll(".line").each(function (d, i) {

            // Get the length of each line in turn
            var totalLength = d3.select("#line" + i).node().getTotalLength();
            // console.log(totalLength);

            d3.selectAll("#line" + i).attr("stroke-dasharray", totalLength + " " + totalLength)
              .attr("stroke-dashoffset", totalLength)
              .transition()
              .duration(3000)
              .attr("stroke-dashoffset", 0);

          });
        }
      });

      // Define responsive behavior
      function resize() {
        var width =
          parseInt(d3.select("#chart").style("width")) - margin.left - margin.right,
          height =
            parseInt(d3.select("#chart").style("height")) -
            margin.top -
            margin.bottom;

        // Update the range of the scale with new width/height
        xScale.range([0, width]);
        yScale.range([height, 0]);

        // Update the axis and text with the new scale
        svg.select(".x.axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis);

        svg.select(".y.axis")
          .attr("transform", "translate(" + width + " ,0)")
          .call(yAxis);

        // Force D3 to recalculate and update the line
        svg.selectAll(".line").attr("d", function (d) {
          return line(d.datapoints);
        });

        // Update the tick marks
        xAxis.ticks(Math.max(width / 75, 2));
        yAxis.ticks(Math.max(height / 50, 2));
      }

      // Call the resize function whenever a resize event occurs
      d3.select(window).on("resize", resize);

      // Call the resize function
      resize();
    }

    draw();

  </script>
</body>

</html>
<!DOCTYPE html>
<html>

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-163898058-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-163898058-1');
  </script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@latest/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.css" rel="stylesheet">

  <link href="styles4.css" rel="stylesheet">
  <style>
  </style>
  <script data-pace-options='{ "target": "div#progressbar"}' src="https://cdn.jsdelivr.net/npm/pace-progressbar@latest/pace.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-progressbar@latest/themes/blue/pace-theme-flash.css">
</head>

<body>
  <div class="container-fluid">

    <div id="progressbar">&nbsp;</div>

    <!-- header -->
    <div class="fixed-top" style="max-height: 60px; ">
      <div class="row p-2">
        <div class="col-9">
          <span id="showAfterLoad" style="display:none;">
            <span id="title" style="display:inline-block; font-size:larger;">Daily new
              <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-secondary"><span id="measure"></span></button>
                <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true"
                  aria-expanded="false">
                  <span class="sr-only">Toggle Dropdown</span>
                </button>
                <div class="dropdown-menu" id="type">
                  <a class="dropdown-item" href="#" data-type="confirmed">confirmed</a>
                  <a class="dropdown-item" href="#" data-type="deaths">deaths</a>
                  <a class="dropdown-item" href="#" data-type="recovered">recovered</a>
                </div>
              </div>
            </span>
            <span style="font-size:8pt;">&nbsp;(updated every day, not clear at what time though)</span>
            <span style="display:block; font-size:smaller; white-space: nowrap; ">
              as of <span id="end"></span>
            </span>
          </span>
          <div style="display:none;" id="link_to_settings">Add country :
            <button type="button" class="add btn btn-sm btn-primary" title="add country" data-toggle="modal" data-target="#exampleModal">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>
        <div class="col col-3" style="display:block; font-size:smaller; overflow:hidden; text-overflow: ellipsis;">
          <div class="float-right" style="text-align: right;">
            sources:
            <a href="https://github.com/pomber/covid19" target="_json-data_source">data</a>
            <i class="fas fa-grip-lines-vertical" style="color:gray;"></i>
            <a href="https://github.com/aequologica/aequologica.github.io/tree/master/covid" target="_github_com">html</a>
          </div>
        </div>
      </div>
    </div>

    <!-- modal country picker -->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog .modal-dialog-scrollable" role="document">
        <div class="modal-content">
          <div class="modal-body">
            <div class="embed-responsive embed-responsive-1by1" style="height:100%">
              <iframe id="settingsAsIFrame" class="embed-responsive-item" src="settings.html" height="100%" allowfullscreen></iframe>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- svg -->
    <svg id="chart"></svg>

    <!-- footer -->
    <div id="my-bottom" class="fixed-bottom" style="font-size:7pt">
      <div class="float-left p-2">
        <div class="card">
          <div class="card-body">
            <div class="custom-control custom-control-inline" style="padding-left: 0.25rem; margin-right: 0.25rem;">
              <input type="range" id="startRangeInput" step="1" min="1" max="366" value="1" class="custom-range" style="width: 50px; height:auto;" />
              &nbsp;
              <label id="startFeedback" class="my-custom-control-label"></label>
            </div>
          </div>
        </div>
      </div>
      <div class="float-right p-2">
        <div class="card">
          <div class="card-body">
            <div class="custom-control custom-control-inline" style="padding-left: 0.25rem; margin-right: 0.25rem;">
              <input type="range" min="1" max="21" value="21" class="custom-range" id="sizeOfAverage" style="width:50px">
              <label class="my-custom-control-label" id="bubble" for="sizeOfAverage" style="min-width:1rem; margin: 0 .3rem; text-align:right; font-family: monospace; "></label>
              <label class="my-custom-control-label" id="subtitle"></label>
            </div>
          </div>
        </div>
      </div>
      <div class="float-right p-2">
        <div class="card">
          <div class="card-body">
            <div class="zero-margin-right custom-control custom-radio custom-control-inline">
              <input type="radio" id="absolute" name="absolute" class="custom-control-input">
              <label class="custom-control-label" for="absolute">absolute</label>
            </div>
            <div class="zero-margin-right custom-control custom-radio custom-control-inline">
              <input type="radio" id="percapita" name="absolute" class="custom-control-input" checked>
              <label class="custom-control-label" for="percapita">per capita</label>
            </div>
          </div>
        </div>
      </div>
      <div class="float-right p-2">
        <div class="card">
          <div class="card-body">
            <div class="zero-margin-right custom-control custom-radio custom-control-inline">
              <input type="radio" id="linear" name="linear" class="custom-control-input">
              <label class="custom-control-label" for="linear">linear</label>
            </div>
            <div class="zero-margin-right custom-control custom-radio custom-control-inline">
              <input type="radio" id="logaritmic" name="linear" class="custom-control-input" checked>
              <label class="custom-control-label" for="logaritmic">logaritmic</label>
            </div>
          </div>
        </div>
      </div>
      <div class="float-right p-2">
        <div class="card">
          <div class="card-body">points:
            <div class="zero-margin-right custom-control custom-radio custom-control-inline">
              <input type="radio" id="showpoints" name="showpoints" class="custom-control-input">
              <label class="custom-control-label" for="showpoints">show</label>
            </div>
            <div class="zero-margin-right custom-control custom-radio custom-control-inline">
              <input type="radio" id="hidepoints" name="showpoints" class="custom-control-input" checked>
              <label class="custom-control-label" for="hidepoints">hide</label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/js/fontawesome.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@latest/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@latest/dist/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@latest/lodash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@latest/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@latest/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.min.js"></script>

  <script id="tooltip-template" type="text/x-handlebars-template">
    <table>
      <caption>
        <div {{{style}}}>{{country}}</div>
        <div style="white-space: nowrap;">{{date}}</div>
        {{#if showAverage}}
        <div style="white-space: nowrap;">{{sizeOfAverage}} day(s) average: {{average}}</div>
        {{/if}}
      </caption>
      <tr><td>{{yesterday}}                                     </td></tr>
      <tr><td style="border-bottom: 1px solid #777">{{delta}} </td></tr>
      <tr><td><b>{{today}}</b>                                  </td></tr>
    </table></script>
  <script id="legend-template" type="text/x-handlebars-template"><div class="card" style="direction: ltr;">
    <div class="card-body">
        <table id="legend" class="">
            <tr>
                <th class="remove">
                    <span>&nbsp;</span>
                </th>
                <th class="country">
                    <button type="button" class="add btn btn-sm btn-primary float-left" title="add country" data-toggle="modal" data-target="#exampleModal">
                        <i class="fas fa-plus"></i></button>
                    <span>&nbsp;</span>
                    <button type="button" id="populationToggle" class="btn btn-sm btn-outline-secondary float-right" title="toggle population column visibility">
                        <i class="fas fa-globe"></i>
                    </button>
                </th>
                <th class="population" style="{{#if isPopulationColumnVisible}}display:table-cell{{else}}display:none{{/if}}">
                    <a style="color: black !important" target="_population-by-country" href="https://www.worldometers.info/world-population/population-by-country/">
                      population
                    </a>
                </th>
            </tr>
            {{#each populations}}
            <tr>
                <td class="remove">
                    <button type="button" class="remove btn btn-sm btn-outline-secondary" title="remove {{alias @key}}" name="{{alias @key}}">
                        <span class="remove">×</span>
                    </button>
                </td>
                <td class="country" style="color: {{color @key}}">{{@key}}</td>
                <td class="population" style="{{#if ../isPopulationColumnVisible}}display:table-cell{{else}}display:none{{/if}}">{{this}}</td>
            </tr>
            {{/each}}
        </table>
    </div>
</div></script>
  <script>
    // compile the template
    const tooltipTemplate = Handlebars.compile(document.getElementById("tooltip-template").innerHTML);

    const legendTemplate = Handlebars.compile(document.getElementById("legend-template").innerHTML);
  </script>

  <!-- https://github.com/doowb/sma -->
  <script src="sma.js"></script> <!-- script src="https://cdn.jsdelivr.net/npm/sma@latest/index.js"></script -->

  <!-- -->
  <script src="population2.js"></script>
  <script src="aliases6.js"></script>
  <script src="legend7.js"></script>
  <script src="measurement2.js"></script>

  <script>
    'use strict';

    // https://stackoverflow.com/a/31732310/1070215
    const isSafari = navigator.vendor && navigator.vendor.indexOf('Apple') > -1 &&
      navigator.userAgent &&
      navigator.userAgent.indexOf('CriOS') == -1 &&
      navigator.userAgent.indexOf('FxiOS') == -1;

    // allons-y
    $(document).ready(() => {

      const margin = { top: 60, right: 80, bottom: 32, left: 0 };

      ///////////////////////////////
      // constants & initializations
      let start;
      {
        const startAsDayOfYear = localStorage.getItem("startAsDayOfYear");
        const defaultStart = "2020-01-22";
        start = startAsDayOfYear ? moment().dayOfYear(startAsDayOfYear) : moment(defaultStart);
        start.subtract(1, 'days');
        $('#startFeedback').text(start.format('LL'));
        $('#startRangeInput').prop('value', start.dayOfYear());

        $('#startRangeInput').on('change', (e) => {
          start = moment().dayOfYear($.prop(e.currentTarget, 'valueAsNumber'));
          localStorage.setItem("startAsDayOfYear", start.dayOfYear());
          raz();
          draw();
        }).on('input', (e) => {
          $('#startFeedback').text(moment().dayOfYear($.prop(e.currentTarget, 'valueAsNumber')).format('LL'));
        });
      }



      const measure = new Measure();

      let sizeOfAverage = 21;
      {
        let tmpString = localStorage.getItem("sizeOfAverage");
        if (tmpString) {
          let tmpInt = +tmpString;
          if (0 < tmpInt < 22) {
            sizeOfAverage = tmpInt;
            let rang = document.getElementById("sizeOfAverage");
            if (rang) {
              let att = document.createAttribute("value");
              att.value = sizeOfAverage;
              rang.setAttributeNode(att);
            }
          }
        }
      }

      let toggleCapita = "percapita";  // "absolute";   // 
      let toggleLinear = "logaritmic"; // "linear";     // 
      let togglePoints = "hidepoints"; // "showpoints"; // 
      {
        {
          const tmp = localStorage.getItem("toggleCapita");
          if (tmp && (tmp == "absolute" || tmp == "percapita")) {
            toggleCapita = tmp;
            const radiobtn = document.getElementById(toggleCapita);
            if (radiobtn) { radiobtn.checked = true; }
          }
        }
        {
          const tmp = localStorage.getItem("toggleLinear");
          if (tmp && (tmp == "linear" || tmp == "logaritmic")) {
            toggleLinear = tmp;
            const radiobtn = document.getElementById(toggleLinear);
            if (radiobtn) { radiobtn.checked = true; }
          }
        }
        {
          const tmp = localStorage.getItem("togglePoints");
          if (tmp && (tmp == "hidepoints" || tmp == "showpoints")) {
            togglePoints = tmp;
            const radiobtn = document.getElementById(togglePoints);
            if (radiobtn) { radiobtn.checked = true; }
          }
        }
      }

      /////////////
      // functions
      function raz() {
        const elem = document.querySelector('#chart');
        if (elem) {
          while (elem.firstChild) {
            elem.removeChild(elem.lastChild);
          }
        }
        document.getElementById("settingsAsIFrame").contentDocument.location.reload(true);
      }

      function draw() {

        // get countries
        function getCountries() {
          let aliases = Aliases.read();

          if (aliases && aliases.length > 0) {
            return _.map(aliases, (a) => Aliases.a2c(a));
          }

          return [];
        }
        const countries = getCountries();
        if (countries.length == 0) {
          $("#link_to_settings").show();
          return;
        } else {
          $("#link_to_settings").hide();
        }

        let startAfterNDeaths = 50;
        let populations = {};
        {
          function getPopulation(country) {
            const countray = _.find(populationByAlias, { 'name': Aliases.c2a(country) });
            return countray.count;
          }
          countries.forEach((country) => {
            _.assign(populations, { [country]: getPopulation(country) });
          });
        }
        // define margins
        const
          width =
            parseInt(d3.select("#chart").style("width")) - margin.left - margin.right,
          height =
            parseInt(d3.select("#chart").style("height")) - margin.top - margin.bottom;

        // define date parser
        const parseDate = d3.timeParse("%Y-%m-%d");
        const formatTime = d3.timeFormat("%e %B");

        // define scales
        const xScale = d3.scaleTime().range([0, width]);
        const yScale = (toggleLinear === "logaritmic" ? d3.scaleSymlog() : d3.scaleLinear()).range([height, 0]);
        const color = d3.scaleOrdinal().range(d3.schemeCategory10);

        // define axes
        const xAxis = d3.axisBottom().scale(xScale);
        const yAxis = d3.axisRight().scale(yScale);
        const yGrid = d3.axisLeft().scale(yScale);

        // define lines
        const line = d3
          .line()
          .curve(d3.curveMonotoneX)
          .x((d) => { return xScale(d.date); })
          .y((d) => { return yScale(d.deltaMovingAverage); });

        // define svg canvas
        const svg = d3
          .select("#chart")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // Read in data
        d3.json("https://pomber.github.io/covid19/timeseries.json").then((dataParam) => {

          let data = {};
          countries.forEach((country) => {
            if (dataParam[country]) {
              _.assign(data, { [country]: dataParam[country] });
            }
          });

          // Set the color domain equal to the countries
          color.domain(countries);

          // parse all dates first, integerify other attributes
          countries.forEach((country) => {
            if (data[country]) {
              data[country].forEach((d) => {
                d.date = parseDate(d.date);
                d.confirmed = +d.confirmed;
                d.deaths = +d.deaths;
                d.recovered = +d.recovered;
              });
            }
          });

          const end = countries.length > 0 ? moment(_.maxBy(data[countries[0]], 'date').date) : moment();
          {
            const latest = new moment(end);
            const earliest = countries.length > 0 ? moment(_.minBy(data[countries[0]], 'date').date) : moment();
            latest.subtract(2, 'days');
            earliest.subtract(1, 'days');
            $('#startRangeInput').prop("max", latest.dayOfYear());
            $('#startRangeInput').prop("min", earliest.dayOfYear());
          }
          $("#showAfterLoad").show();

          // calc start date as with respect to first # of deaths for all countries
          /*
          if (measure.getType() === "deaths") {
            let firstNDeaths = {};

            countries.forEach((country) => {
              const found = _.find(data[country], (d) => { return d.deaths >= startAfterNDeaths; })
              if (found) {
                firstNDeaths[country] = found;
              }

            });
            const firstNDeathsArray = _.values(firstNDeaths);

            firstNDeathsArray.sort((a, b) => moment(a.date) - moment(b.date) );
            if (firstNDeathsArray.length > 0) {
              const minFirstNDeaths = firstNDeathsArray[0];
              start = moment(minFirstNDeaths.date);
            }
          }
          */

          // format the data 
          if (countries.length > 0) {
            countries.forEach((country) => {

              let previousMeasure = 0;

              data[country].forEach((d) => {
                const thisMeasure = measure.func(d);
                d.delta = (thisMeasure - previousMeasure);
                if (toggleCapita == "percapita") {
                  d.delta = 1000000 * d.delta / populations[country];
                }
                previousMeasure = thisMeasure;
              });

              const deltas = _.map(data[country], 'delta');
              let deltasMovingAverage = sma(deltas, sizeOfAverage);
              for (let i = 0; i < deltasMovingAverage.length; i++) {
                deltasMovingAverage[i] = +deltasMovingAverage[i];
              }

              {
                let i = 0;
                data[country].forEach((d) => {
                  d.deltaMovingAverage = i < sizeOfAverage ? 0 : deltasMovingAverage[i + 1 - sizeOfAverage];
                  i = i + 1;
                });
              }

              data[country] = _.filter(data[country], (d) => moment(d.date).isSameOrAfter(start));
            });
          }

          // reformat data to make it more copasetic for d3
          const measures = countries.map((country) => {
            return {
              category: country,
              datapoints: data[country]
            };
          });

          // TODO add trendline with https://observablehq.com/@harrystevens/d3-regression-with-datetimes?collection=@harrystevens/d3-regression

          if (countries.length > 0) {
            // set the domain of the axes
            xScale.domain(
              d3.extent(measures[0].datapoints, (d) => {
                return d.date;
              })
            );
            const yExtents = measures.map((item) => {
              return d3.extent(item.datapoints, (d) => {
                return d.deltaMovingAverage;
              });
            });
            const yExtent = [
              d3.min(yExtents, (d) => { return d[0] }),
              d3.max(yExtents, (d) => { return d[1] })
            ];
            yScale.domain(yExtent);

            // place the axes on the chart
            svg
              .append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis);

            svg
              .append("g")
              .attr("class", "y axis")
              .attr("transform", "translate(" + width + ", 0)")
              .call(yAxis);

            svg.append("g")
              .attr("class", "grid")
              .style("stroke-dasharray", ("2,5"))
              .call(yGrid
                .tickSize(-width)
                .tickFormat("")
              );

            const products = svg
              .selectAll(".category")
              .data(measures)
              .enter()
              .append("g")
              .attr("class", "category")
              .attr("id", (d, i) => {
                return "country_" + i;
              }).attr("name", (d) => {
                return d.category;
              }).attr("color", (d) => {
                return color(d.category);
              });

            products
              .append("path")
              .attr("class", "line")
              .attr("id", (d, i) => {
                return "line_" + i;
              })
              .attr("d", (d) => {
                return line(d.datapoints);
              })
              .style("stroke", (d) => {
                return color(d.category);
              });

            // http://datawanderings.com/2019/11/01/tutorial-making-an-interactive-line-chart-in-d3-js-v-5/
            // https://bl.ocks.org/d3noob/a22c42db65eb00d4e369
            // Define the div for the tooltip
            d3.selectAll("div.mytooltip").remove();
            const tt = d3.select(".container-fluid").append("div")
              .attr("class", "mytooltip")
              .style("opacity", 0);

            function getNumberWithSign(input) {
              const sign = input < 0 ? '-' : '+';

              return `${sign}${Math.round(Math.abs(input)).toLocaleString()}`;
            }

            var drawPoints = function () {
              products.selectAll("points")
                .data((d) => { return d.datapoints })
                .enter()
                .append("circle")
                .attr("cx", (d) => xScale(d.date))
                .attr("cy", (d) => yScale(d.deltaMovingAverage))
                .attr("r", 4)
                .lower()
                .attr("data-d", (d, i) => {d.i=i; return JSON.stringify(d)})
                .attr("class", "point")
                .on("mouseover", function (d) {
                  tt.style("opacity", 1);
                  const prevD = JSON.parse($(this).next().attr("data-d"));
                  tt.html(tooltipTemplate({
                    style: 'style="color: ' + $(this).parent().css("color") + '"',
                    country: $(this).parent().attr("name"),
                    date: formatTime(d.date),
                    today: d[measure.getType()].toLocaleString(),
                    delta: getNumberWithSign(d[measure.getType()] - prevD[measure.getType()]),
                    yesterday: prevD[measure.getType()].toLocaleString(),
                    average: getNumberWithSign(d.deltaMovingAverage),
                    sizeOfAverage: sizeOfAverage,
                    showAverage: sizeOfAverage > 1 ? true : false,
                  }))
                    .style("left", (d3.event.pageX - 100) + "px")
                    .style("top", (d3.event.pageY - 100) + "px");
                })
                .on("mouseout", (d) => {
                });

              $("svg#chart").on("click", (e) => {
                if (!$(e.target).is("circle")) {
                  tt.style("opacity", 0);
                }

              });
            }

            Legend.draw(svg, populations, color, isSafari ? margin.top : 0, height, legendTemplate, () => {
              raz();
              draw();
            });
          }

          // titles, etc.
          document.getElementById("measure").innerHTML = measure.getType();
          document.getElementById("end").innerHTML = end.format('LL');
          document.getElementById("bubble").innerHTML = sizeOfAverage;
          document.getElementById("subtitle").innerHTML =
            sizeOfAverage < 2
              ? "day <span style='text-decoration: line-through'>average</span>"
              : "days                                            average";

          // animate cf. http://bl.ocks.org/fryford/2925ecf70ac9d9b51031
          {
            d3.selectAll(".line").style("opacity", "0.5");

            // select All of the lines and process them one by one
            d3.selectAll(".line").each((d, i) => {

              // get the length of each line in turn
              const ID = "#line_" + i;
              const totalLength = d3.select(ID).node().getTotalLength();

              const line = d3.selectAll(ID)
                .attr("stroke-dasharray", totalLength + " " + totalLength)
                .attr("stroke-dashoffset", totalLength)
                .transition()
                .duration(3000)
                .attr("stroke-dashoffset", 0)
                .on("start", togglePoints === "showpoints" ? drawPoints : () => { });
            });
          }
        });

        // define responsive behavior
        function resize() {
          const width = parseInt(d3.select("#chart").style("width")) - margin.left - margin.right,
            height = parseInt(d3.select("#chart").style("height")) - margin.top - margin.bottom;

          // Update the range of the scale with new width/height
          xScale.range([0, width]);
          yScale.range([height, 0]);

          // Update the axis and text with the new scale
          svg.select(".x.axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);
          svg.select(".y.axis")
            .attr("transform", "translate(" + width + " ,0)")
            .call(yAxis);
          svg.select(".grid")
            .attr("transform", "translate(" + -width + " ,0)")
            .call(yGrid);
          // update the tick marks
          xAxis.ticks(Math.max(width / 75, 2));
          yAxis.ticks(Math.max(height / 50, 2));
          yGrid.ticks(Math.max(height / 50, 2));

          // force D3 to recalculate and update the line
          svg.selectAll(".line").attr("d", (d) => {
            return line(d.datapoints);
          });

          svg.selectAll("circle")
            .attr("cx", (d) => { return xScale(d.date); })
            .attr("cy", (d) => { return yScale(d.deltaMovingAverage); })
          // console.log("resized! " + new Date());
        }

        // call resize whenever a resize event occurs
        d3.select(window).on("resize", _.debounce(() => {
          raz();
          draw();
        }, 500));

        // call the resize function
        resize();
      }

      /////////////////
      // html handlers
      $('#exampleModal').on('hidden.bs.modal', () => {
        raz();
        draw();
      })

      $('.dropdown-toggle').dropdown();

      $(".dropdown-item").on("click", (e) => {
        const newType = $(e.currentTarget).data("type");
        measure.setType(newType);
        // location.reload();
        raz();
        draw();
      });

      const ranges = document.querySelectorAll('#sizeOfAverage[type="range"]');
      ranges.forEach((r) => {
        r.addEventListener("input", () => {
          bubble.innerHTML = r.value;
        });
        r.addEventListener("change", () => {
          bubble.innerHTML = r.value;
          if (sizeOfAverage != r.value) {
            sizeOfAverage = r.value;
            localStorage.setItem("sizeOfAverage", sizeOfAverage);
            raz();
            draw();
          }
        });
      });

      const radios = document.querySelectorAll('[type="radio"]');
      radios.forEach((r) => {
        r.addEventListener("click", (event) => {
          const oldLinear = toggleLinear, oldCapita = toggleCapita, oldPoints = togglePoints;
          switch (event.currentTarget.id) {
            case "linear":
              toggleLinear = "linear";
              localStorage.setItem("toggleLinear", toggleLinear);
              break;
            case "logaritmic":
              toggleLinear = "logaritmic";
              localStorage.setItem("toggleLinear", toggleLinear);
              break;
            case "absolute":
              toggleCapita = "absolute";
              localStorage.setItem("toggleCapita", toggleCapita);
              break;
            case "percapita":
              toggleCapita = "percapita";
              localStorage.setItem("toggleCapita", toggleCapita);
              break;
            case "showpoints":
              togglePoints = "showpoints";
              localStorage.setItem("togglePoints", togglePoints);
              break;
            case "hidepoints":
              togglePoints = "hidepoints";
              localStorage.setItem("togglePoints", togglePoints);
              break;
            default:
              ;
          }
          if (oldLinear != toggleLinear || oldCapita != toggleCapita || oldPoints != togglePoints) {
            raz();
            draw();
          }
        });
      });

      //////////////////
      // the main entry
      draw();

    }); // $(document).ready

  </script>
</body>

</html>
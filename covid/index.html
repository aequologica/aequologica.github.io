<!DOCTYPE html>
<html>

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-163898058-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-163898058-1');
  </script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <style>
    body {
      font: 12px sans-serif;
    }

    #legend .parent {
      transform: scaleX(-1);
    }

    #legend .sleeve {
      transform: scaleX(-1);
    }

    #legend .table-responsive {
      max-height: 240px !important;
    }

    #legend button {
      padding: 0 .3rem;
    }

    #legend .remove button {
      padding: 0;
      border: none;
    }

    #legend td.country,
    #legend td.population {
      padding-right: .3rem;
    }

    #legend th.population,
    #legend td.population {
      font-family: monospace;
      text-align: right;
    }

    #chart {
      width: 100%;
      height: 94%;
      position: absolute;
      /* z-index: -1; */
    }

    .axis path,
    .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
    }

    .line {
      fill: none;
      stroke: steelblue;
      stroke-width: 4px;
    }

    .grid line {
      stroke: #bbccdd;
    }

    tr,
    .card-body {
      background-color: ghostwhite;
    }

    .card {
      display: inline-block !important;
      vertical-align: bottom;
    }

    #legend .card-body,
    .fixed-bottom#my-bottom .card-body {
      padding: .2rem .3rem !important;
      padding-top: 0.2rem !important;
      padding-right: 0.3rem !important;
      padding-bottom: 0.2rem !important;
      padding-left: 0.3rem !important;
    }

    .zero-margin-right {
      margin-right: 0 !important;
    }

    .my-custom-control-label {
      position: relative;
      margin-bottom: 0;
      vertical-align: top;
    }

    .modal-body {
      height: 80vh;
      overflow-y: auto;
    }

    .tooltip {
      fill: #2b2929;
      font-family: Georgia;
      font-size: 150%;
    }

    .point {
      stroke: none;
      fill: #9c9c9c;
      opacity: .2;
    }
  </style>

  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
  <div class="container-fluid">


    <div class="fixed-top" , style="max-height: 60px; ">
      <!-- overflow-y: hidden; -->
      <div class="row p-2">

        <div class="col-9">
          <span id="title" style="display:inline-block; font-size:larger;">Daily
            <!-- Example split danger button -->
            <div class="btn-group">
              <button type="button" class="btn btn-sm btn-outline-secondary"><span id="measure"></span></button>
              <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                <span class="sr-only">Toggle Dropdown</span>
              </button>
              <div class="dropdown-menu" id="type">
                <a class="dropdown-item disabled" href="#" data-type="confirmed">confirmed</a>
                <a class="dropdown-item" href="#" data-type="deaths">deaths</a>
                <a class="dropdown-item disabled" href="#" data-type="recovered">recovered</a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item disabled" href="#" data-type="active">active (= confirmed - deaths - recovered)</a>
                <a class="dropdown-item disabled"><img src="Baustelle.svg" style="width: 24px; height:auto;;"> <i>disabled menu items coming soon</i></a>
              </div>
            </div>
          </span>
          <span style="display:block; font-size:smaller; white-space: nowrap; overflow:hidden; text-overflow: ellipsis;">as of <span id="end"></span> (updated every day at 3am
            UTC)</span>
        </div>

        <div class="col col-3" style="display:block; font-size:smaller; overflow:hidden; text-overflow: ellipsis;">
          <div class="float-right" style="text-align: right;">
            sources:
            <a href="https://github.com/pomber/covid19" target="_json-data_source">data</a>
            |
            <a href="https://github.com/aequologica/aequologica.github.io/blob/master/covid/index.html" target="_json_data_source">html</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog .modal-dialog-scrollable" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Countries</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="embed-responsive embed-responsive-1by1" style="height:100%">
              <!--  -->
              <iframe class="embed-responsive-item" src="settings.html" height="100%" allowfullscreen></iframe>
            </div>
          </div>
        </div>
      </div>
    </div>


    <svg id="chart"></svg>


    <div id="my-bottom" class="fixed-bottom" style="font-size:10pt">
      <div class="float-right p-2">
        <div class="card" style="vertical-align: bottom;">
          <div class="card-body">
            <div class="custom-control custom-control-inline" style="padding-left: 0.25rem; margin-right: 0.25rem;">
              <input type="range" min="1" max="12" value="4" class="custom-range" id="range" style="width:80px">
              <label class="my-custom-control-label" id="bubble" for="range" style="min-width:1rem; margin: 0 .3rem; text-align:right; font-family: monospace; "></label>
              <label class="my-custom-control-label" id="subtitle"></label>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-body">
            <div class="zero-margin-right custom-control custom-radio custom-control-inline">
              <input type="radio" id="absolute" name="absolute" class="custom-control-input" checked>
              <label class="custom-control-label" for="absolute">absolute</label>
            </div>
            <div class="zero-margin-right custom-control custom-radio custom-control-inline">
              <input type="radio" id="percapita" name="absolute" class="custom-control-input">
              <label class="custom-control-label" for="percapita">per capita</label>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-body">
            <div class="zero-margin-right custom-control custom-radio custom-control-inline">
              <input type="radio" id="linear" name="linear" class="custom-control-input" checked>
              <label class="custom-control-label" for="linear">linear</label>
            </div>
            <div class="zero-margin-right custom-control custom-radio custom-control-inline">
              <input type="radio" id="logaritmic" name="linear" class="custom-control-input">
              <label class="custom-control-label" for="logaritmic">logaritmic</label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>

  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js" integrity="sha256-VeNaFBVDhoX3H+gJ37DpT/nTuZTdjYro9yBruHjVmoQ=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@5.15.1/dist/d3.min.js" integrity="sha256-SQJ/nCYPXFPuqoS56EfnesDBPNiitndOIfN2WdPRi/o=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.24.0/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>

  <!-- https://github.com/doowb/sma -->
  <!-- script src="https://cdn.jsdelivr.net/npm/sma@0.1.1/index.min.js"></script -->
  <script src="sma.js"></script>
  <script src="population.js"></script>
  <script src="aliases.js"></script>
  <script src="legend2.js"></script>
  <script src="measurement.js"></script>

  <script>
    'use strict';

    var measure = new Measure();
    var average = "deltaMovingAverage";
    var sizeOfAverage = 4;
    {
      var tmpString = localStorage.getItem("sizeOfAverage");
      if (tmpString) {
        var tmpInt = +tmpString;
        if (0 < tmpInt < 13) {
          sizeOfAverage = tmpInt;
          var rang = document.getElementById("range");
          if (rang) {
            var att = document.createAttribute("value");
            att.value = sizeOfAverage;
            rang.setAttributeNode(att);
          }
        }
      }
    }

    /////////////////
    // html handlers
    $('#exampleModal').on('hidden.bs.modal', function () {
      location.reload();
    })

    $('.dropdown-toggle').dropdown();

    $(".dropdown-item").on("click", function (e) {
      var newType = $(e.currentTarget).data("type");
      measure.setType(newType);
      location.reload();
    });

    var ranges = document.querySelectorAll('[type="range"]');
    ranges.forEach(function (r) {
      r.addEventListener("input", () => {
        bubble.innerHTML = r.value;
      });
      r.addEventListener("change", () => {
        bubble.innerHTML = r.value;
        if (sizeOfAverage != r.value) {
          sizeOfAverage = r.value;
          localStorage.setItem("sizeOfAverage", sizeOfAverage);
          raz();
          draw();
        }
      });
    });

    var radios = document.querySelectorAll('[type="radio"]');
    radios.forEach(function (r) {
      r.addEventListener("click", function (event) {
        var oldLinear = toggleLinear, oldCapita = toggleCapita;
        switch (this.id) {
          case "linear":
            toggleLinear = "linear";
            localStorage.setItem("toggleLinear", toggleLinear);
            break;
          case "logaritmic":
            toggleLinear = "logaritmic";
            localStorage.setItem("toggleLinear", toggleLinear);
            break;
          case "absolute":
            toggleCapita = "absolute";
            localStorage.setItem("toggleCapita", toggleCapita);
            break;
          case "percapita":
            toggleCapita = "percapita";
            localStorage.setItem("toggleCapita", toggleCapita);
            break;
          default:
            ;
        }
        if (oldLinear != toggleLinear || oldCapita != toggleCapita) {
          raz();
          draw();
        }
      });
    });

    // constants & initialization
    var asses = Aliases.read();
    var countries;
    if (asses != null && asses.length > 0) {
      countries = _.map(asses, (a) => Aliases.a2c(a));
    } else {
      countries = [];
    }

    var startAfterNDeaths = 5;
    var populations = {};
    function getPopulation(country) {
      var countray = _.find(populationByAlias, { 'name': Aliases.c2a(country) });
      return countray.count;
    }
    countries.forEach(function (country) {
      _.assign(populations, { [country]: getPopulation(country) });
    });
    var toggleCapita = "absolute"; // "percapita"
    var toggleLinear = "linear";   // "logaritmic"
    {
      var tmp = localStorage.getItem("toggleCapita");
      if (tmp && (tmp == "absolute" || tmp == "percapita")) {
        toggleCapita = tmp;
        var radiobtn = document.getElementById(toggleCapita);
        if (radiobtn) { radiobtn.checked = true; }
      }
    }
    {
      var tmp = localStorage.getItem("toggleLinear");
      if (tmp && (tmp == "linear" || tmp == "logaritmic")) {
        toggleLinear = tmp;
        var radiobtn = document.getElementById(toggleLinear);
        if (radiobtn) { radiobtn.checked = true; }
      }
    }

    function raz() {
      var elem = document.querySelector('#chart');
      if (elem) {
        while (elem.firstChild) {
          elem.removeChild(elem.lastChild);
        }
      }
    }

    function draw() {
      // Define margins
      var margin = { top: 60, right: 56, bottom: 32, left: 0 },
        width =
          parseInt(d3.select("#chart").style("width")) - margin.left - margin.right,
        height =
          parseInt(d3.select("#chart").style("height")) - margin.top - margin.bottom;

      // Define date parser
      var parseDate = d3.timeParse("%Y-%m-%d");

      // Define scales
      var xScale = d3.scaleTime().range([0, width]);
      var yScale = (toggleLinear == "logaritmic" ? d3.scaleSymlog() : d3.scaleLinear()).range([height, 0]);
      var color = d3.scaleOrdinal().range(d3.schemeCategory10);

      // Define axes
      var xAxis = d3.axisBottom().scale(xScale);
      var yAxis = d3.axisRight().scale(yScale);

      // Define lines
      var line = d3
        .line()
        .curve(d3.curveMonotoneX)
        .x(function (d) {
          return xScale(d.date);
        })
        .y(function (d) {
          return yScale(d[average]);
        });

      // Define svg canvas
      var svg = d3
        .select("#chart")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      // grid lines
      function make_y_gridlines(height) {
        return d3.axisRight(yScale)
          .ticks(Math.max(height / 50, 2));
      }
      // Read in data
      d3.json("https://pomber.github.io/covid19/timeseries.json").then(function (dataParam) {

        var data = {};
        countries.forEach(function (country) {
          if (dataParam[country]) {
            _.assign(data, { [country]: dataParam[country] });
          }
        });
        // parse all dates first
        countries.forEach(function (country) {
          if (data[country]) {
            data[country].forEach(function (d) {
              d.date = parseDate(d.date);
            });
          }
        });

        // Set the color domain equal to the countries
        color.domain(countries);

        // calc start date as with respect to first # of deaths for all countries
        var start = moment("2020-02-01"); // default
        var end = countries.length > 0 ? moment(_.maxBy(data[countries[0]], 'date').date) : moment();

        {
          var firstNDeaths = {};

          countries.forEach(function (country) {
            var found = _.find(data[country], function (d) { return d.deaths >= startAfterNDeaths; })
            if (found) {
              firstNDeaths[country] = found;
            }

          });
          var firstNDeathsArray = _.values(firstNDeaths);

          firstNDeathsArray.sort(function compare(a, b) {
            return moment(a.date) - moment(b.date);
          });
          if (firstNDeathsArray.length > 0) {
            var minFirstNDeaths = firstNDeathsArray[0];
            start = moment(minFirstNDeaths.date);
          }

        }

        // Format the data 
        if (countries.length > 0) {
          countries.forEach(function (country) {

            var prev = 0;

            data[country].forEach(function (d) {
              d.delta = (measure.func(d) - prev);
              if (toggleCapita == "percapita") {
                d.delta = d.delta / (populations[country] / 1000000)
              }
              prev = measure.func(d);
            });

            var deltas = _.map(data[country], 'delta');
            var deltasMovingAverage = sma(deltas, sizeOfAverage);
            for (var i = 0; i < deltasMovingAverage.length; i++) {
              deltasMovingAverage[i] = +deltasMovingAverage[i];
            }

            var i = 0;
            data[country].forEach(function (d) {
              d.deltaMovingAverage = i < sizeOfAverage ? 0 : deltasMovingAverage[i + 1 - sizeOfAverage];
              i = i + 1;
            });

            data[country] = _.filter(data[country], function (d) {
              return moment(d.date).isSameOrAfter(start);
            });
          });

        }

        // Reformat data to make it more copasetic for d3
        // data = An array of objects
        // measures = An array of three objects, each of which contains an array of objects
        var measures = countries.map(function (country) {
          return {
            category: country,
            datapoints: data[country]
          };
        });

        // console.log(JSON.stringify(measures, null, 2)) // to view the structure

        // Set the domain of the axes
        if (countries.length > 0) {
          xScale.domain(
            d3.extent(measures[0].datapoints, function (d) {
              return d.date;
            })
          );

          var yExtents = measures.map(function (item) {
            return d3.extent(item.datapoints, function (d) {
              return d[average];
            });
          });
          var yExtent = [
            d3.min(yExtents, function (d) { return d[0] }),
            d3.max(yExtents, function (d) { return d[1] })
          ];
          yScale.domain(yExtent);

          // Place the axes on the chart
          svg
            .append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);

          svg
            .append("g")
            .attr("class", "y axis")
            .attr("transform", "translate(" + width + ", 0)")
            .call(yAxis);

          var products = svg
            .selectAll(".category")
            .data(measures)
            .enter()
            .append("g")
            .attr("class", "category");

          products
            .append("path")
            .attr("class", "line")
            .attr("id", function (d, i) {
              return "line" + i;
            })
            .attr("d", function (d) {
              return line(d.datapoints);
            })
            .style("stroke", function (d) {
              return color(d.category);
            });

          // http://datawanderings.com/2019/11/01/tutorial-making-an-interactive-line-chart-in-d3-js-v-5/
          var drawPoints = function () {
            const tooltip = d3.select("body").append("div")
              .attr("class", "tooltip")
              .style("opacity", 0)
              .style("position", "absolute");

            products.selectAll("points")
              .data(function (d) { return d.datapoints })
              .enter()
              .append("circle")
              .attr("cx", function (d) { return xScale(d.date); })
              .attr("cy", function (d) { return yScale(d[average]); })
              .attr("r", 2)
              .attr("class", "point");

            svg.append("g")
              .attr("class", "grid")
              .style("stroke-dasharray", ("3,3"))
              .call(make_y_gridlines(height)
                .tickSize(width)
                .tickFormat("")
              );
              Legend.draw(svg, populations, color, height);
          }
        }


        

        // titles, etc.
        document.getElementById("measure").innerHTML = measure.getType();
        document.getElementById("end").innerHTML = end.format('LL');
        document.getElementById("bubble").innerHTML = sizeOfAverage;
        document.getElementById("subtitle").innerHTML =
          sizeOfAverage < 2
            ? "day <span style='text-decoration: line-through'>average</span>"
            : "days                                            average";

        // animate cf. http://bl.ocks.org/fryford/2925ecf70ac9d9b51031
        {
          var i = 0;
          d3.selectAll(".line").style("opacity", "0.5");

          //Select All of the lines and process them one by one
          d3.selectAll(".line").each(function (d, i) {

            // Get the length of each line in turn
            var totalLength = d3.select("#line" + i).node().getTotalLength();
            // console.log(totalLength);

            d3.selectAll("#line" + i).attr("stroke-dasharray", totalLength + " " + totalLength)
              .attr("stroke-dashoffset", totalLength)
              .transition()
              .duration(3000)
              .attr("stroke-dashoffset", 0)
              .on("end", drawPoints);

          });
        }
      });

      // Define responsive behavior
      function resize() {
        var width =
          parseInt(d3.select("#chart").style("width")) - margin.left - margin.right,
          height =
            parseInt(d3.select("#chart").style("height")) -
            margin.top -
            margin.bottom;

        // Update the range of the scale with new width/height
        xScale.range([0, width]);
        yScale.range([height, 0]);

        // Update the axis and text with the new scale
        svg.select(".x.axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis);

        svg.select(".y.axis")
          .attr("transform", "translate(" + width + " ,0)")
          .call(yAxis);

        // Force D3 to recalculate and update the line
        svg.selectAll(".line").attr("d", function (d) {
          return line(d.datapoints);
        });
        svg.selectAll("circle")
          .attr("cx", function (d) { return xScale(d.date); })
          .attr("cy", function (d) { return yScale(d[average]); })

        // Update the tick marks
        xAxis.ticks(Math.max(width / 75, 2));
        yAxis.ticks(Math.max(height / 50, 2));
        svg.selectAll(".grid").call(make_y_gridlines(height)
          .tickSize(width)
          .tickFormat("")
        );
      }

      // Call the resize function whenever a resize event occurs
      d3.select(window).on("resize", resize);

      // Call the resize function
      resize();
    }

    draw();

  </script>
</body>

</html>
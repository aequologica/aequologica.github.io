<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/css/theme.bootstrap_4.min.css" rel="stylesheet">
    <style>
        body {
            font: 14px sans-serif;
        }

        table.table-responsive {
            max-height: 300px;
        }

        th.population,
        td.population {
            font-family: monospace;
            text-align: right;
        }

        th.center,
        td.center {
            text-align: center;
        }

        table.table-fit {
            width: auto !important;
            table-layout: auto !important;
        }

        table.table-fit thead th,
        table.table-fit tfoot th {
            width: auto !important;
        }

        table.table-fit tbody td,
        table.table-fit tfoot td {
            width: auto !important;
        }
    </style>
</head>

<body>
    <button 
        type="button" 
        class="reset btn btn-outline-secondary float-right" 
        title="reset list of countries to factory defaults"
        onclick="Aliases.reset();location.reload();">
        &#8634;
    </button>
    <div class="container-fluid">
         <table id="countries" class="table table-sm table-striped table-hover table-fit tablesorter">
            <thead>
                <tr>
                    <th scope="col" class="center">&nbsp;</th>
                    <th scope="col">country</th>
                    <th scope="col" class="population">population</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js" integrity="sha256-VeNaFBVDhoX3H+gJ37DpT/nTuZTdjYro9yBruHjVmoQ=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.24.0/moment.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/js/jquery.tablesorter.min.js"></script>
    <script src="population.js"></script>
    <script src="aliases.js"></script>
    <!-- Include Handlebars from a CDN -->
    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
    <script id="row-template" type="text/x-handlebars-template">
<tr id="r">
    <td class="center">
        <span id="trucAndAstuce" style="display:none">{{checked}}</span><!-- r{{inde}} {{inde}} style="visibility:hidden"-->
        <span class="form-check">
            <input class="form-check-input position-static" type="checkbox" id="cb{{inde}}" value="{{inde}}" {{checked}}>
        </span>
    </td>
    <td>
        <span id="n{{inde}}">{{alias}}</span>
    </td>
    <td class="population">
        {{popula}}
    </td>
</tr></script>
    <script>
        // compile the template
        var template = Handlebars.compile(document.getElementById("row-template").innerHTML);
    </script>
    <script>
        var i = 0;
        var locallyStoredAliases = Aliases.read();
        var t = $("table#countries tbody")
        populationByAlias.forEach(function (alias) {
            if (Aliases.isExcluded(alias.name)) {
                return;
            }
            var html = template({
                inde: i,
                alias: alias.name,
                popula: alias.count.toLocaleString(),
                checked: (_.sortedIndexOf(locallyStoredAliases, alias.name) >= 0 ? "checked" : "unchecked"),
            });
            t.append(html);
            i = i + 1;
        });

        var $table_sorter = $("#countries").tablesorter({
            theme : "bootstrap",
            sortList: [[0,0]],
        });

        function toggle(event) {
            event.stopPropagation();

            $table_sorter.trigger('update');
            var locallyStoredAliases = [];
            $("input:checkbox:checked").each(function () {
                locallyStoredAliases.push($("#n" + $(this).val()).text());
            });
            Aliases.write(locallyStoredAliases);
        }

        var $trs = $('tbody tr');
        $trs.on("change", (event) => {
            var $eventTarget = $(event.target);
            if ($eventTarget.is("input")) {
                var $tr = $eventTarget.closest('tr');
                var $cb = $eventTarget;

                var $truc = $tr.find( "span#trucAndAstuce" );
                $truc.text($cb.is(':checked') ? "checked" : "unchecked");
                toggle(event);
            }
        }).on("mouseup", (event) => {
            var $eventTarget = $(event.target);
            if (!$eventTarget.is("input")) {
                var $tr = $eventTarget.closest('tr');
                var $cb = $tr.find( "input" )
                $cb.prop('checked', !$cb.prop('checked'));
                var $truc = $tr.find( "span#trucAndAstuce" );
                $truc.text($cb.is(':checked')  ? "checked" : "unchecked");
                toggle(event);
            }
        });

    </script>
</body>

</html>
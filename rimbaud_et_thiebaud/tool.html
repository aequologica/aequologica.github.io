<!DOCTYPE HTML>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>

  <meta name="viewport"             content="width=device-width, initial-scale=1"/>
  <meta name="google"               content="notranslate"/>
  <meta name="title"                content="Outil"/>
  <meta name="description"          content="Tool to sync and post soundcloud comments"/>
  <meta name="author"               content="Christophe Thiebaud"/>

  <meta http-equiv="Content-Language" content="en" />
  <meta http-equiv="X-UA-Compatible"  content="IE=edge,chrome=1"/>

  <title>post synced soundcloud comments</title>

  <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <link rel="stylesheet" type="text/css" href="animate.css">
  <link rel="stylesheet" type="text/css" href="sticky-footer-navbar.css">

  <link rel="stylesheet" type="text/css" href="style.css">

  <link rel="shortcut icon" href="/favicon2.ico">  

  <style type="text/css">
  .done {
  	text-decoration: line-through;
  }
  ul#result > li:hover {
    background-color: #e0e0e0;
    opacity: 1;
    cursor: pointer; 
  }
  h1, h2, h3 {
  	margin-top: 0;
  }
  </style>
  
</head>

<body>

  <div id="main" class="container">

    <div class="row" style="margin-bottom: 1em;">
      <h1 class="col-md-6" id="title" style="float:left;">post synced soundcloud comments</h1>
      <h2 class="col-md-6"><span id="me" style="float:right;">anonymous</span></h2>
    </div>

    <form id="id_from_url" class="form-inline"  style="margin-bottom: 1em">
      <label for="soundcloudURL">soundcloud URL</label>
      <input type="text" class="form-control" id="soundcloudURL" placeholder="https://soundcloud.com/â€¦" style="width:80%" value="">
      <button type="submit" class="btn btn-default"><i class="fa fa-search"></i></button>
    </form>

    <div id="revealMe" style="display:none;">

      <div class="row" style="margin-bottom: 1em">
        <h3 id="soundcloudID" class="col-md-6" style="float:left;">not found</h3>
        <div class="col-md-6" ><button id="load" type="button" class="btn btn-default" style="float:right;">"<i class="fa fa-upload"></i></button> </div>
      </div>

      <button id="post" type="button" class="btn btn-primary">post to soundcloud</button>   
      <button id="reset" type="button" class="btn btn-default">reset</button>    
      <div class="progress" style="margin-top: 1em">
        <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="1" style="width: 0%;">
          &nbsp;
        </div>
      </div>
       
      <div class="row">
        <ul class="col-md-6" id="result">
        </ul>   
        <div class="col-md-6">
          <div style="float:right; font-size:smallest;font-style: italic; color:gray;">shift-enter for new line | enter to submit</div>
          <textarea id="entry" style="width:100%;">
          </textarea>
          <button id="fromRightToLeft" type="button" class="btn btn-default"><i class="fa fa-chevron-left"></i><i class="fa fa-chevron-left"></i></button>
        </div>
      </div>   

      <div class="progress">
        <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="1" style="width: 0%;">
          &nbsp;
        </div>
      </div>
      <button id="post" type="button" class="btn btn-primary">post to soundcloud</button>    
      <button id="reset" type="button" class="btn btn-default">reset</button> 

    </div>

  </div>

</body>

</html>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js" ></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"            ></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"      ></script>
<script type="text/javascript" src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"          ></script>    
<script type="text/javascript" src="//cdn.jsdelivr.net/jquery.scrollto/2.1.0/jquery.scrollTo.min.js"        ></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/numeral.js/1.4.5/numeral.min.js"       ></script>

<script type="text/javascript" src="https://w.soundcloud.com/player/api.js"                                 ></script>
<script type="text/javascript" src="//connect.soundcloud.com/sdk.js"></script>

<script type="text/javascript" src="jquery.lettering-0.6.1.min.js"></script>   
<script type="text/javascript" src="jquery.textillate.js"></script>    

<script type="text/javascript" src="app.js"></script>

<script type="text/javascript">
$( document ).ready(function() {

  // initialize client with app credentials
  SC.initialize({
    client_id: '506d2e8c1cd057aa783906b0b1c8fe0d',
    redirect_uri: 'http://aequologica.net/callback.html'
  });

  // initiate auth popup
  SC.connect(function() {
    SC.get('/me', function(me) { 
      $('span#me').html(me.username); 
    });
  });

  /*
  init function
  */
  function init(soundcloudID) {

    $('h3#soundcloudID').text(soundcloudID);

    var $iframe = $('<iframe id="sc-widget" width="100%" height="128px" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/'+soundcloudID+'&auto_play=false&buying=false&liking=false&download=false&sharing=false&show_artwork=false&show_comments=false&show_playcount=false&show_user=false&hide_related=false&visual=true&start_track=0&callback=true"/>');

    $('iframe').remove();
    $('.progress').removeClass('progress-striped active');  
    $('.progress-bar').removeClass('progress-bar-success');   
    $('.progress-bar').css('width', '0%').attr({'aria-valuenow': 0, 'aria-valuemax' : 1 }).html('&nbsp;'); 
    $('button#load').text('load ' + soundcloudID + '.txt');
    $('div#revealMe').prepend($iframe).css( "display", "block");

    var mySouncCloudModule = MySouncCloudModule(soundcloudID);

    function loadData(data) {
      $("#result").empty();
      
      var lines = data.split('\n');

      for(var i = 0;i < lines.length;i++){
        var ligne = lines[i].trim();
        ligne = ligne.length == 0 ? '&nbsp;' : ligne;
        $( "#result" ).append( $('<li>').html(ligne) );
      }

      $( "ul#result>li" ).click(function() {
        var $_this_ = $(this);
        if (!$_this_.hasClass('done')) {
          mySouncCloudModule.getPosition(function(position) {
            var tex = $_this_.text();
            $_this_.addClass('done');
            $_this_.append($('<span style="float:right">').html('&nbsp;['+position+']'));
            qwe.push({'text': tex, 'timestamp': position});
          }); 
        } else {
          console.log('alread done!');
        }
      });
    }

    $('button#fromRightToLeft').click(function() {
      var data = $('textarea#entry').val();
      loadData(data);
    });

	  $(document.body).on( 'keypress', 'textarea#entry', undefined, function(e) {
	    if (e.which === 13  && !event.shiftKey) { // if is enter
	      e.preventDefault(); // don't submit form
	      var data = $(this).val();
      	loadData(data);
	    }
	  });   
    
    function loadFile(soundcloudID) {
      $.get( soundcloudID+".txt", function( data ) {
      	loadData(data);
        $('button#load').html('<i class="fa fa-upload"></i>&nbsp;' + soundcloudID + '.txt');
      }).fail(function() {
        $('button#load').html('<i class="fa fa-upload"></i>&nbsp;' + soundcloudID + '.txt not found');
      });
    }

    $('button#load').click(function(event) {
      var soundcloudID = $('h3#soundcloudID').text();
      loadFile(soundcloudID);
    });

    loadFile(soundcloudID);

    var qwe = [];
    var errorQueue = [];

    $('button#post').click(function(event) {

      qwe.sort(function(a, b) {
          return +a.timestamp - +b.timestamp;
      });

      qwe.reverse();

      $('.progress-bar').removeClass('progress-bar-success progress-bar-warning');   
	    $('.progress').addClass('progress-striped active');  
      $('.progress-bar').css('width', '0%').attr({'aria-valuenow': 0, 'aria-valuemax' : qwe.length }).html('&nbsp;'); 
      
      var delta = 1200; // milliseconds between POSTs
      
      for (var index = 0; index < qwe.length; index++) {

        setTimeout(function(i) {
          var ligne = qwe[i];
/* */
          SC.post(
            "https://api.soundcloud.com/tracks/"+soundcloudID+"/comments/?client_id=506d2e8c1cd057aa783906b0b1c8fe0d", 
            { 
              'comment[body]': ligne.text,
              'comment[timestamp]': ligne.timestamp
            }, 
            function(response, error) { 
/* */
              var percent = Math.ceil((100.0*(i+1))/qwe.length)+'%';
              $('.progress-bar').css('width', percent).attr('aria-valuenow', i).text(ligne.text)  ;  
/*
              var error = 0; 
*/
              if (error) {
                errorQueue.push(error);
                $('.progress-bar').removeClass('progress-bar-success');   
                $('.progress-bar').addClass('progress-bar-warning');   
                console.log(error); 
              } else { 
                // console.log(response); 
              }

              if (i == qwe.length-1) {
                $('.progress').removeClass('progress-striped active');  
                if (errorQueue.length == 0) {
                  $('.progress-bar').addClass('progress-bar-success');   
                } else {
                  $('.progress-bar').addClass('progress-bar-warning');   
                }
              }
/* */
          });
/* */
         }, index * delta, index); // we're passing index     
      }
    });

    $('button#reset').click(function(event) {
      qwe = [];
      
      $('.progress').removeClass('progress-striped active');
      $('.progress-bar').removeClass('progress-bar-success');   
      $('.progress-bar').css('width', '0%').attr({'aria-valuenow': 0, 'aria-valuemax' : qwe.length }).html('&nbsp;'); 
      $('ul#result > li').removeClass('done');

      $.each($('ul#result > li'), function( index, value ) {
  		  $(this).children().remove().end().text($.trim($(this).text()));
	    });
    });
  }

  /*
  search handler
  */
  $( "form#id_from_url" ).submit(function( event ) {
    event.preventDefault();

    var soudcloudURL = $('input#soundcloudURL').val().trim();

    if (soudcloudURL) {
      SC.get('/resolve', {'url': soudcloudURL}, function(data) { 
        if (typeof data.errors != 'undefined') {
          $.each(data.errors, function(index, error) {
            alert(soudcloudURL + " : " + error.error_message);
          }); 
        } else  {
          if (typeof data.id != 'undefined') {
            init(data.id);
          } else {
            alert('not able to get an ID from soudcloud URL : ' + soudcloudURL);
          }
        }
      });
    } else {
      console.log('empty soudcloudURL, loading hardcoded 200813526.');
    	init('200813526');
    }
  });

});
</script>


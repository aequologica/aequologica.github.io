<!DOCTYPE HTML>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>

  <meta name="viewport"             content="width=device-width, initial-scale=1"/>
  <meta name="google"               content="notranslate"/>
  <meta name="title"                content=""/>
  <meta name="description"          content=""/>
  <meta name="author"               content="Christophe Thiebaud"/>

  <meta http-equiv="Content-Language" content="fr" />
  <meta http-equiv="X-UA-Compatible"  content="IE=edge,chrome=1"/>

  <title>Outil</title>

  <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <link href="animate.css" rel="stylesheet">
  <link href="sticky-footer-navbar.css" rel="stylesheet">

  <link rel="shortcut icon" href="/favicon2.ico">  

  <link rel="stylesheet" href="style.css">

  <style type="text/css">
  .done {
  	text-decoration: line-through;
  }
  ul#result > li:hover {
    background-color: #e0e0e0;
    opacity: 1;
  }
  h1, h2, h3 {
  	margin-top: 0;
  }
  </style>
  
</head>

<body>

<div id="main" class="container">

<div class="row">
<h1 id="title" class="col-md-6" style="float:left;">Outil</h1>
<h2 class="col-md-6"><span id="me" style="float:right;">anonymous</span></h2>
</div>

<form id="target" class="form-inline">
    <label for="soundcloudURL">soundcloud URL</label>
    <input type="text" class="form-control" id="soundcloudURL" placeholder="https://soundcloud.com/â€¦" style="width:80%" value="">
    <button type="submit" class="btn btn-default"><i class="fa fa-search"></i></button>
</form>

<div id="revealMe" style="display:none;">

<h3 id="soundcloudID">not found</h3>
<button id="load" type="button" class="btn">load text</button> 

<button id="post" type="button" class="btn btn-default">post to soundcloud</button>   
<button id="clear" type="button" class="btn btn-default">clear</button>    

<div class="progress">
  <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="1" style="width: 0%;">
  &nbsp;
  </div>
</div>
 
<div class="row">   
<ul class="col-md-12" id="result"></ul>   
</div>   

<div class="progress">
  <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="1" style="width: 0%;">
  &nbsp;
  </div>
</div>
<button id="post" type="button" class="btn btn-default">post to soundcloud</button>    
<button id="clear" type="button" class="btn">clear</button> 

</div>

</div>

</body>

</html>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js" ></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"            ></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"      ></script>
<script type="text/javascript" src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"          ></script>    
<script type="text/javascript" src="//cdn.jsdelivr.net/jquery.scrollto/2.1.0/jquery.scrollTo.min.js"        ></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/numeral.js/1.4.5/numeral.min.js"       ></script>

<script type="text/javascript" src="https://w.soundcloud.com/player/api.js"                                 ></script>
<script type="text/javascript" src="//connect.soundcloud.com/sdk.js"></script>

<script type="text/javascript" src="jquery.lettering-0.6.1.min.js"></script>
<script type="text/javascript" src="jquery.textillate.js"></script>
<script type="text/javascript" src="jquery.fittext.js"></script>

<script type="text/javascript" src="app.js"></script>

<script type="text/javascript">
$( document ).ready(function() {

  // initialize client with app credentials
  SC.initialize({
    client_id: '506d2e8c1cd057aa783906b0b1c8fe0d',
    redirect_uri: 'http://aequologica.net/callback.html'
  });

  // initiate auth popup
  SC.connect(function() {
    SC.get('/me', function(me) { 
      $('span#me').html(me.username); 
    });
  });

  /*
  init function
  */
  function init(soundcloudID) {

    $('h3#soundcloudID').text(soundcloudID);

    var $iframe = $('<iframe id="sc-widget" width="100%" height="128px" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/'+soundcloudID+'&auto_play=false&buying=false&liking=false&download=false&sharing=false&show_artwork=false&show_comments=false&show_playcount=false&show_user=false&hide_related=false&visual=true&start_track=0&callback=true"/>');

    $('iframe').remove();
    $('.progress').removeClass('progress-striped active');  
    $('.progress-bar').css('width', '0%').attr({'aria-valuenow': 0, 'aria-valuemax' : 1 }).html('&nbsp;'); 
    $('button#load').text('load ' + soundcloudID + '.txt');
    $('div#revealMe').prepend($iframe).css( "display", "block");

    var mySouncCloudModule = MySouncCloudModule(soundcloudID);
    
    function loadText(soundcloudID) {
      $.get( soundcloudID+".txt", function( data ) {

        $('button#load').text("reload "+soundcloudID+'.txt');
        $("#result").empty();
      
        var lines = data.split('\n');

        for(var i = 0;i < lines.length;i++){
          var ligne = lines[i].trim();
          ligne = ligne.length == 0 ? '&nbsp;' : ligne;
          $( "#result" ).append( $('<li>').html(ligne) );
        }

        $( "ul#result>li" ).click(function() {
          var $_this_ = $(this);
          if (!$_this_.hasClass('done')) {
            mySouncCloudModule.getPosition(function(position) {
              $_this_.addClass('done');
              qwe.push({'text': $_this_.text(), 'timestamp': position});
            }); 
          } else {
            console.log('alread done!');
          }
        });

      }).fail(function() {
        $('button#load').text(soundcloudID+'.txt not found. Retry ?');
      });
    }

    $('button#load').click(function(event) {
      var soundcloudID = $('h3#soundcloudID').text();
      loadText(soundcloudID);
    });

    var qwe = [];

    loadText(soundcloudID);

    $('button#post').click(function(event) {

      qwe.sort(function(a, b) {
          return +a.timestamp - +b.timestamp;
      });

      qwe.reverse();

	  $('.progress').addClass('progress-striped active');  
      $('.progress-bar').css('width', '0%').attr({'aria-valuenow': 0, 'aria-valuemax' : qwe.length }).html('&nbsp;'); 
      var index = 0;
      var delta = 1200;
      for (; index < qwe.length; index++) {
        setTimeout(function(i) {
          var ligne = qwe[i];
        /* */
          SC.post(
            "https://api.soundcloud.com/tracks/"+soundcloudID+"/comments/?client_id=506d2e8c1cd057aa783906b0b1c8fe0d", 
            { 'comment[body]': ligne.text,
              'comment[timestamp]': ligne.timestamp}, 
            function(response, error) { 
        /* */
              var percent = Math.ceil((100.0*(i+1))/qwe.length)+'%';
              console.log(percent);
              $('.progress-bar').css('width', percent).attr('aria-valuenow', i).text(ligne.text);  
        /* */
              if (error) console.log(error); else console.log(response); 
          });
        /* */
        }, index * delta, index); // we're passing index        
      }
      setTimeout(function() {
        $('.progress').removeClass('progress-striped active');  
      }, index * delta);
      
    });

    $('button#clear').click(function(event) {
      qwe = [];
      $('.progress').removeClass('progress-striped active');  
      $('.progress-bar').css('width', '0%').attr({'aria-valuenow': 0, 'aria-valuemax' : qwe.length }).html('&nbsp;'); 
      $('ul#result > li').removeClass('done');
    });
  }

  /*
  search handler
  */
  $( "#target" ).submit(function( event ) {
    event.preventDefault();

    var searchFor = $('input#soundcloudURL').val().trim();

    if (searchFor) {
      SC.get('/resolve', {'url': searchFor}, function(data) { 
          if (typeof data.errors != 'undefined') {
          $.each(data.errors, function(index, error) {
            alert(searchFor+ " : " + error.error_message);
          })  
        } else  {
          if (typeof data.id != 'undefined') {
            init(data.id);
          }
        }
      });
    }
  });

});
</script>

